apiVersion: v1
kind: Pod
metadata:
  name: {{ template "hmcts.releaseName" . }}-test-service
  annotations:
    "helm.sh/hook": test-success
spec:
  containers:
  - name: {{ template "hmcts.releaseName" . }}-test-service
    image: busybox
    env:
      - name: SERVICE_NAME
        value: {{ template "hmcts.releaseName" . }}
    command: ["sh", "-c"]
    args:
      - echo 'Testing readiness';
        readinessStatusCode=$(wget -S http://$SERVICE_NAME/health 2>&1 | grep HTTP/ | awk 'END{print $2}');
        test "$readinessStatusCode" = "200"; echo $?;
        echo 'Testing liveness';
        livenessStatusCode=$(wget -S http://$SERVICE_NAME/health/liveness 2>&1 | grep HTTP/ | awk 'END{print $2}');
        test "$livenessStatusCode" = "200"; echo $?;
    resources:
      limits:
        cpu: 2500m
        memory: 1Gi
      requests:
        cpu: 25m
        memory: 512Mi
  restartPolicy: Never
