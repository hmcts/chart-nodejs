name: Nodejs Chart CI Pipeline

trigger:
  branches:
    include:
      - refs/tags/*

pr:
  branches:
    include:
      - master

resources:
  repositories:
    - repository: cnp-library
      type: github
      name: hmcts/cnp-azuredevops-libraries
      endpoint: hmcts
      ref: msl8r-patch-1

variables:
  - name: agentPool
    value: ubuntu-latest
  - name: acrName
    value: hmctspublic
  - name: acrResourceGroup
    value: rpe-acr-prod-rg
  - name: serviceConnection
    value: azurerm-prod
  - name: buildPath
    value: chart-nodejs/test-image
  - name: repoName
    value: chart-nodejs

jobs:
  - job: Validate
    pool:
      vmImage: ${{ variables.agentPool }}
    steps:
      - checkout: self
        clean: true

      - task: Bash@3
        condition: eq(variables['Build.Reason'], 'PullRequest')
        inputs:
          targetType: "inline"
          workingDirectory: $(repoName)
          script: |
            if git diff --name-only master..$(System.PullRequest.SourceBranch) --  | grep -q '^test-image/.*'; then
              echo '##vso[task.setvariable variable=testImageChanged]true'
            else
              echo '##vso[task.setvariable variable=testImageChanged]false' 
            fi
      # Look at only triggering this when test-image dir changes
      - ${{ if and(eq(variables['Build.Reason'], 'PullRequest'), eq(variables['testImageChanged'], 'true')) }}:
          - template: steps/acr-build.yaml@cnp-library
            parameters:
              serviceConnection: $(serviceConnection)

      - template: steps/charts/validate.yaml@cnp-library
        parameters:
          chartNamespace: chart-tests
          chartName: nodejs
          chartReleaseName: chart-nodejs-ci-test
          chartPath: $(repoName)/
          valuesFile: $(repoName)/ci-values.yaml
          additionalHelmArgs: --set image=hmctspublic.azurecr.io/hmcts/chart-nodejs:pr-$(System.PullRequest.PullRequestNumber)
  - job: Release
    # Make sure we are on the master branch with a tag
    # to trigger this job
    condition: >
      and(
          succeeded(),
          startsWith(variables['Build.SourceBranch'], 'refs/tags/')
        )
    dependsOn: Validate
    pool:
      vmImage: ${{ variables.agentPool }}
    steps:
      - template: steps/charts/release.yaml@cnp-library
        parameters:
          chartNamespace: chart-tests
          chartName: nodejs
          chartReleaseName: chart-nodejs
